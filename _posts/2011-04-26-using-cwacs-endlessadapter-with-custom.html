---
layout: post
title: Using CWAC's EndlessAdapter with a custom adapter
date: '2011-04-26T14:49:00.010+10:00'
author: Zarah Dominguez
tags:
- listview
- android
- custom adapter
- endless adapter
modified_time: '2011-12-21T00:09:23.918+11:00'
blogger_id: tag:blogger.com,1999:blog-8588450866181483028.post-8222314515145947714
blogger_orig_url: http://www.zdominguez.com/2011/04/using-cwacs-endlessadapter-with-custom.html
---

In one of my projects, the app has the potential to display a very, and I mean very, long list. To minimize the loading time of the app, I limit the number of items initially included in the list and then add to it as the user scrolls down.<br /><br />For this purpose, <a href="http://commonsware.com/">Mark Murphy</a>'s <a href="https://github.com/commonsguy/cwac-endless">EndlessAdapter</a> works wonders. I was trying to make it work with a <tt>CursorAdapter</tt> though, but due to time constraints, I was not able to continue with my experiment.<br /><br />And then I found out that some of the items in my list are HTML-formatted. Huh. So I have to have a custom adapter to override <tt>getView()</tt>. I patterned my code on the demo included in the <tt>EndlessAdapter</tt> project and I was at a loss. Maybe it's because I just came from a vacation and my mind refuses to work. Hmmm.<br /><br />To cut a long and arduous journey short, I was able to figure it out. Here's a sample activity that displays a list of countries from an array. To illustrate using a custom adapter, I add the list item number when setting the item text.<br /><br />I will discuss the pertinent parts of the code in detail.<br /><pre class="brush:java">private void init() {<br /> LIST_SIZE = COUNTRIES.length;  <br /> for (int i=0; i&lt;=BATCH_SIZE; i++){<br />  countriesSub.add(COUNTRIES[i]);   <br /> }<br /> <br /> setLastOffset(BATCH_SIZE);<br /> displayList(countriesSub);<br />}</pre>In this part of the code, I get the first 10 items in the list as the initial contents of the list. Of course, our current list is small and is peanuts for <tt>ListView</tt>. This is just to illustrate my point. In my app, I initially load 2,000 items. I also make sure to remember where I am in my source list. In my case, it is the offset in the original array. This might also be a row in the DB, or the ID in an RSS feed.<br /><br />The <tt>ArrayList <i>countriesSub</i></tt> holds the items that are currently in my list. As the user goes through the list, this array will grow.<br /><br />To display my list, I set an instance of <tt>DemoAdapter</tt> as my list adapter. <tt>DemoAdapter</tt> inherits from <tt>EndlessAdapter</tt> and in its constructor, I give it an instance of my custom <tt>ArrayAdapter</tt>.<br /><pre class="brush:java">@Override<br />  public View getView(int position, View convertView, ViewGroup parent) {<br /><br />   ViewHolder holder;   <br /><br />   if(convertView==null){<br />    LayoutInflater inflater = (LayoutInflater)<br />    EndlessCustom.this.getSystemService(Context.LAYOUT_INFLATER_SERVICE);<br />    convertView = inflater.inflate(android.R.layout.simple_list_item_1, null);<br />    holder = new ViewHolder();<br />    holder.word = (TextView)convertView.findViewById(android.R.id.text1);<br /><br />    convertView.setTag(holder);<br />   } else{<br />    holder=(ViewHolder)convertView.getTag();<br />   }<br /><br />   holder.word.setText(String.valueOf(position+1) + ". " + countriesSub.get(position));<br />   return convertView;<br />  }</pre><br />The important part in my custom <tt>ArrayAdapter</tt> is the <tt>getView()</tt> method. In this method, I tell the adapter to not simply display the <tt>.toString()</tt> value of the item, but to add a number before it.<br /><br />Notice that I use the <tt>ViewHolder</tt> pattern as <a href="http://developer.android.com/resources/samples/ApiDemos/src/com/example/android/apis/view/List14.html">illustrated in the Android Developers site</a>.<br /><pre class="brush:java; tab-size: 5">DemoAdapter() {<br /> super(new CustomArrayAdapter(EndlessCustom.this, <br />  android.R.layout.simple_list_item_1, android.R.id.text1, countriesSub));<br /><br /> rotate=new RotateAnimation(0f, 360f, Animation.RELATIVE_TO_SELF,<br />  0.5f, Animation.RELATIVE_TO_SELF,<br />  0.5f);<br /> rotate.setDuration(600);<br /> rotate.setRepeatMode(Animation.RESTART);<br /> rotate.setRepeatCount(Animation.INFINITE);<br />}</pre><br />So now we come to the <tt>EndlessAdapter</tt> part. In the constructor, I pass into it an instance of my custom <tt>ArrayAdapter</tt>, indicating the source of the list, the layout for each row, and the <tt>TextView</tt> ID from the layout. I also instantiated the animation that will be used while the list is loading the additional items.<br /><pre class="brush:java">@Override<br />protected boolean cacheInBackground() {<br /> tempList.clear();<br /> int lastOffset = getLastOffset();<br /> if(lastOffset &lt; LIST_SIZE){<br />  int limit = lastOffset + BATCH_SIZE;<br />  for(int i=(lastOffset+1); (i&lt;=limit &amp;&amp; i&lt;LIST_SIZE); i++){<br />   tempList.add(COUNTRIES[i]);<br />  } <br />   <br />  setLastOffset(limit);<br /><br />  if(limit&lt;LIST_SIZE){<br />   return true;<br />  } else {<br />   return false;<br />  }<br /> } else  {<br />  return false;<br /> }<br />}</pre>We have to override <tt>cacheInBackground()</tt> for <tt>EndlessAdapter</tt> to work. Here we do the heavy lifting like querying the server, reading from the DB, etc. Here, I load the next 10 items from the original list and put them in a temporary <tt>ArrayList</tt>. I also check whether I have loaded all the data, and if so, tell the <tt>EndlessAdapter</tt> to not show the extra row at the bottom. I do this by returning <tt>false</tt> from the method.<br /><pre class="brush:java; tab-size: 5">@Override<br />protected void appendCachedData() {<br /> @SuppressWarnings("unchecked")<br /> ArrayAdapter&lt;String&gt; arrAdapterNew = (ArrayAdapter&lt;String&gt;)getWrappedAdapter();<br /><br /> int listLen = tempList.size();<br /> for(int i=0; i&lt;listLen; i++){<br />  arrAdapterNew.add(tempList.get(i));<br /> }<br />}</pre>Finally, I add the newly retrieved rows to my current list. And that's it.<br /><br />The complete Java file for this activity follows:<br /><pre class="brush:java; collapse: true">package com.test.example;<br /><br />import java.util.ArrayList;<br />import java.util.List;<br /><br />import android.app.ListActivity;<br />import android.content.Context;<br />import android.os.Bundle;<br />import android.view.LayoutInflater;<br />import android.view.View;<br />import android.view.ViewGroup;<br />import android.view.animation.Animation;<br />import android.view.animation.RotateAnimation;<br />import android.widget.ArrayAdapter;<br />import android.widget.TextView;<br /><br />import com.commonsware.cwac.endless.EndlessAdapter;<br /><br />public class EndlessCustom extends ListActivity {<br /><br /> static int LIST_SIZE;<br /> private int mLastOffset = 0;<br /> <br /> static final int BATCH_SIZE = 10;<br /> <br /> ArrayList&lt;String&gt; countriesSub = new ArrayList&lt;String&gt;();<br /> <br /> @Override<br /> public void onCreate(Bundle savedInstanceState) {<br />  super.onCreate(savedInstanceState);<br />  setContentView(R.layout.lib_activity_dictionary);<br />  init();<br /> }<br /><br /> private void init() {<br />  LIST_SIZE = COUNTRIES.length;  <br />  for (int i=0; i&lt;=BATCH_SIZE; i++){<br />   countriesSub.add(COUNTRIES[i]);   <br />  }<br />  setLastOffset(BATCH_SIZE);<br />  displayList(countriesSub);<br /> }<br /><br /> private void setLastOffset(int i) {<br />  mLastOffset = i;  <br /> }<br /> <br /> private int getLastOffset(){<br />  return mLastOffset;<br /> }<br /><br /> private void displayList(ArrayList&lt;String&gt; countriesSub) {  <br />  setListAdapter(new DemoAdapter());<br /> }<br /><br /> private class CustomArrayAdapter extends ArrayAdapter&lt;String&gt;{<br /><br />  public CustomArrayAdapter(Context context, int resource,<br />    int textViewResourceId, List&lt;String&gt; objects) {<br />   super(context, resource, textViewResourceId, objects);<br />  }  <br /><br />  @Override<br />  public View getView(int position, View convertView, ViewGroup parent) {<br /><br />   ViewHolder holder;   <br /><br />   if(convertView==null){<br />    LayoutInflater inflater = (LayoutInflater)<br />    EndlessCustom.this.getSystemService(Context.LAYOUT_INFLATER_SERVICE);<br />    convertView = inflater.inflate(android.R.layout.simple_list_item_1, null);<br />    holder = new ViewHolder();<br />    holder.word = (TextView)convertView.findViewById(android.R.id.text1);<br /><br />    convertView.setTag(holder);<br />   } else{<br />    holder=(ViewHolder)convertView.getTag();<br />   }<br /><br />   holder.word.setText(String.valueOf(position+1) + ". " + countriesSub.get(position));<br />   return convertView;<br />  }<br /><br />  public class ViewHolder{<br />   public TextView word;        <br />  }  <br /> }<br /><br /> class DemoAdapter extends EndlessAdapter {<br />  private RotateAnimation rotate=null;<br />  ArrayList&lt;String&gt; tempList = new ArrayList&lt;String&gt;();<br />  <br />  DemoAdapter() {<br />   super(new CustomArrayAdapter(EndlessCustom.this, <br />     android.R.layout.simple_list_item_1, android.R.id.text1, countriesSub));<br /><br />   rotate=new RotateAnimation(0f, 360f, Animation.RELATIVE_TO_SELF,<br />     0.5f, Animation.RELATIVE_TO_SELF,<br />     0.5f);<br />   rotate.setDuration(600);<br />   rotate.setRepeatMode(Animation.RESTART);<br />   rotate.setRepeatCount(Animation.INFINITE);<br />  }<br /><br />  @Override<br />  protected View getPendingView(ViewGroup parent) {<br />   View row=getLayoutInflater().inflate(R.layout.row, null);<br /><br />   View child=row.findViewById(android.R.id.text1);<br />   child.setVisibility(View.GONE);<br />   child=row.findViewById(R.id.throbber);<br />   child.setVisibility(View.VISIBLE);<br />   child.startAnimation(rotate);<br /><br />   return(row);<br />  }<br /><br />  @Override<br />  protected boolean cacheInBackground() {<br />   tempList.clear();<br />   int lastOffset = getLastOffset();<br />   if(lastOffset &lt; LIST_SIZE){<br />    int limit = lastOffset + BATCH_SIZE;<br />    for(int i=(lastOffset+1); (i&lt;=limit &amp;&amp; i&lt;LIST_SIZE); i++){<br />     tempList.add(COUNTRIES[i]);<br />    }    <br />    setLastOffset(limit);<br />    <br />    if(limit&lt;LIST_SIZE){<br />     return true;<br />    } else {<br />     return false;<br />    }<br />   } else  {<br />    return false;<br />   }<br />  }<br /><br /><br />  @Override<br />  protected void appendCachedData() {<br /><br />   @SuppressWarnings("unchecked")<br />   ArrayAdapter&lt;String&gt; arrAdapterNew = (ArrayAdapter&lt;String&gt;)getWrappedAdapter();<br /><br />   int listLen = tempList.size();<br />   for(int i=0; i&lt;listLen; i++){<br />    arrAdapterNew.add(tempList.get(i));<br />   }<br />  }<br /> }<br /> <br /> <br /> static final String[] COUNTRIES = new String[] {<br />        "Afghanistan", "Albania", "Algeria", "American Samoa", "Andorra", <br />        "Angola", "Anguilla", "Antarctica", "Antigua and Barbuda", "Argentina",<br />        "Armenia", "Aruba", "Australia", "Austria", "Azerbaijan",<br />        "Bahrain", "Bangladesh", "Barbados", "Belarus", "Belgium",<br />        "Belize", "Benin", "Bermuda", "Bhutan", "Bolivia",<br />        "Bosnia and Herzegovina", "Botswana", "Bouvet Island", "Brazil", "British Indian Ocean Territory",<br />        "British Virgin Islands", "Brunei", "Bulgaria", "Burkina Faso", "Burundi",<br />        "Cote d'Ivoire", "Cambodia", "Cameroon", "Canada", "Cape Verde",<br />        "Cayman Islands", "Central African Republic", "Chad", "Chile", "China",<br />        "Christmas Island", "Cocos (Keeling) Islands", "Colombia", "Comoros", "Congo",<br />        "Cook Islands", "Costa Rica", "Croatia", "Cuba", "Cyprus", "Czech Republic",<br />        "Democratic Republic of the Congo", "Denmark", "Djibouti", "Dominica", "Dominican Republic",<br />        "East Timor", "Ecuador", "Egypt", "El Salvador", "Equatorial Guinea", "Eritrea",<br />        "Estonia", "Ethiopia", "Faeroe Islands", "Falkland Islands", "Fiji", "Finland",<br />        "Former Yugoslav Republic of Macedonia", "France", "French Guiana", "French Polynesia",<br />        "French Southern Territories", "Gabon", "Georgia", "Germany", "Ghana", "Gibraltar",<br />        "Greece", "Greenland", "Grenada", "Guadeloupe", "Guam", "Guatemala", "Guinea", "Guinea-Bissau",<br />        "Guyana", "Haiti", "Heard Island and McDonald Islands", "Honduras", "Hong Kong", "Hungary",<br />        "Iceland", "India", "Indonesia", "Iran", "Iraq", "Ireland", "Israel", "Italy", "Jamaica",<br />        "Japan", "Jordan", "Kazakhstan", "Kenya", "Kiribati", "Kuwait", "Kyrgyzstan", "Laos",<br />        "Latvia", "Lebanon", "Lesotho", "Liberia", "Libya", "Liechtenstein", "Lithuania", "Luxembourg",<br />        "Macau", "Madagascar", "Malawi", "Malaysia", "Maldives", "Mali", "Malta", "Marshall Islands",<br />        "Martinique", "Mauritania", "Mauritius", "Mayotte", "Mexico", "Micronesia", "Moldova",<br />        "Monaco", "Mongolia", "Montserrat", "Morocco", "Mozambique", "Myanmar", "Namibia",<br />        "Nauru", "Nepal", "Netherlands", "Netherlands Antilles", "New Caledonia", "New Zealand",<br />        "Nicaragua", "Niger", "Nigeria", "Niue", "Norfolk Island", "North Korea", "Northern Marianas",<br />        "Norway", "Oman", "Pakistan", "Palau", "Panama", "Papua New Guinea", "Paraguay", "Peru",<br />        "Philippines", "Pitcairn Islands", "Poland", "Portugal", "Puerto Rico", "Qatar",<br />        "Reunion", "Romania", "Russia", "Rwanda", "Sqo Tome and Principe", "Saint Helena",<br />        "Saint Kitts and Nevis", "Saint Lucia", "Saint Pierre and Miquelon",<br />        "Saint Vincent and the Grenadines", "Samoa", "San Marino", "Saudi Arabia", "Senegal",<br />        "Seychelles", "Sierra Leone", "Singapore", "Slovakia", "Slovenia", "Solomon Islands",<br />        "Somalia", "South Africa", "South Georgia and the South Sandwich Islands", "South Korea",<br />        "Spain", "Sri Lanka", "Sudan", "Suriname", "Svalbard and Jan Mayen", "Swaziland", "Sweden",<br />        "Switzerland", "Syria", "Taiwan", "Tajikistan", "Tanzania", "Thailand", "The Bahamas",<br />        "The Gambia", "Togo", "Tokelau", "Tonga", "Trinidad and Tobago", "Tunisia", "Turkey",<br />        "Turkmenistan", "Turks and Caicos Islands", "Tuvalu", "Virgin Islands", "Uganda",<br />        "Ukraine", "United Arab Emirates", "United Kingdom",<br />        "United States", "United States Minor Outlying Islands", "Uruguay", "Uzbekistan",<br />        "Vanuatu", "Vatican City", "Venezuela", "Vietnam", "Wallis and Futuna", "Western Sahara",<br />        "Yemen", "Yugoslavia", "Zambia", "Zimbabwe"<br />    };<br />}</pre><br />If you know of a more efficient way to do this, please do not hesitate to let me know! :)